version: '3.8'

services:
  mongodb:
    image: mongo:7
    container_name: legalbot-mongodb
    ports:
      - "27017:27017"
    volumes:
      - ./data/mongodb:/data/db
    env_file:
      - .env
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
    networks:
      legalbot-network:
        aliases:
          - mongodb
          - db

  qdrant:
    image: qdrant/qdrant:latest
    container_name: legalbot-qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - ./data/qdrant:/qdrant/storage
    networks:
      legalbot-network:
        aliases:
          - qdrant
          - vector-db

  ollama:
    image: ollama/ollama:latest
    container_name: legalbot-ollama
    ports:
      - "11434:11434"
    volumes:
      - ./data/ollama:/root/.ollama
    networks:
      legalbot-network:
        aliases:
          - ollama
          - llm

  backend:
    build:
      context: .
      dockerfile: build/backend/Dockerfile
    container_name: legalbot-backend
    # Puerto no expuesto directamente, solo accesible a través de nginx
    expose:
      - "8000"
    volumes:
      - ./data/backend:/app
    depends_on:
      - mongodb
      - qdrant
      - ollama
    env_file:
      - .env
    environment:
      MONGODB_URL: ${MONGODB_URL}
      MONGODB_DATABASE: ${MONGODB_DATABASE:-legalbot}
      QDRANT_URL: ${QDRANT_URL}
      OLLAMA_URL: ${OLLAMA_URL}
      OLLAMA_MODEL: ${OLLAMA_MODEL:-mistral}
    networks:
      legalbot-network:
        aliases:
          - backend
          - api
    command: >
      sh -c "pip install --no-cache-dir -r requirements.txt && uvicorn main:app --host 0.0.0.0 --port 8000 --reload"

  nginx:
    build:
      context: .
      dockerfile: build/nginx/Dockerfile
    container_name: legalbot-nginx
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - ./data/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./data/nginx/conf.d:/etc/nginx/conf.d:ro
      - ./data/nginx/includes:/etc/nginx/includes:ro
      # Archivos estáticos del frontend (build de Vue)
      - ./data/static:/usr/share/nginx/html:ro
      # Logs
      - ./data/logs/nginx:/var/log/nginx
    depends_on:
      frontend:
        condition: service_completed_successfully
      backend:
        condition: service_started
    networks:
      legalbot-network:
        aliases:
          - nginx
          - proxy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/nginx-health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s

  frontend:
    build:
      context: .
      dockerfile: build/frontend/Dockerfile
    container_name: legalbot-frontend
    volumes:
      - ./data/frontend:/app
      - ./data/static:/app/dist
    env_file:
      - .env
    environment:
      - NODE_ENV=development
      - VITE_API_URL=${VITE_API_URL:-/api}
    command: sh -c "cd /app && npm install && npm run build && cp -r dist/* /app/dist/ || true"
    networks:
      legalbot-network:
        aliases:
          - frontend
          - web
    restart: "no"

networks:
  legalbot-network:
    driver: bridge

